# SSH Config

## Deployment Service SSH Config

This directory contains an SSH config file with `Host` entries for all of our
bastions in different regions, which is intended to serve as a canonical config
that will be updated over time. To use it, add a line _at the top_ of your
`~/.ssh/config` file referencing the ssh config file in this repo:

> `Include ~/path/to/deployment-service-config/developer-configs/ssh/bastion_v3`

This will allow you to pull updates to this repo and have them take effect
automatically without needing to update your ~/.ssh/config file.

## SECEDGE SSH Config

You will also need to set up the
[SECEDGE SSH
config](https://bitbucket.oci.oraclecorp.com/projects/secedge/repos/ssh_configs/browse)
as well. To do so, clone that repo then add a second line to the top of your
`~/.ssh/config` file including the SSH config from that repo as well (as
explained in the README of that repo):

> `Include ~/path/to/ssh_configs/config`

## HOW TO SSH

Accessing the hosts Access the desired host by hostname alias. The hostname aliases are configured in $HOME/.ssh/dlcdep_configs/*_hosts files.
> ssh dply-svc-ctrl-plne-api-beta-ad1.PHX
 $ sudo odoctl docker ps

## GENERATING THE HOSTS LISTS
This step is only needed when adding a new region. The dlcdep_configs directory contains a list of host files, e.g., dlcdep_phoneix_prod_hosts. They are generated by running the python script: genrated_hosts.py as below. In order to run this py script, you need to set up an OCI CLI profile in $HOME/.oci/config file.

For non-prod envs (dev, test), in $HOME/.oci/config file, setup your OCI CLI with a profile named dlcdep-boat and specify the region to us-ashburn-1, then run: ./generate_hosts.py DEV phoenix > dlcdep_configs/dlcdep_phoenix_beta_hosts

The available region names are: ashburn, phoenix

### For a New Region
With these SSH configs, when a new region is added to DLCDEP, do the following to get access to the service hosts in the new region:

### Prepare the Jump Host File
Update provisioning/ssh_config/generate_hosts.py to add the new region names. See other region names as references.
In provisioning/ssh_config/dlcdep_configs directory, create a new file: dlcdep_<new region>_jumphosts. See other files in the same direcotry as references.
In the new file dlcdep_<new region name>_jumphosts: do some modifications:
Host: the jump host name for the new region.
HostName: the private IP address of the dlcdep-phoenix-beta-jump instance in deployment_bastion compartment in dlcdeploymentdev tenancy for the new region. This info can be found from OCI console.
ProxyJump: 
The bastion host CNAMe for the new region. It should be given by SECEDGE in the comment of the ticket that we filed to SECEDGE to peer to our jump host local peer gateway for the region.  
 
first find out the security list of the bastionjump instance via OCI console, 
then find out the matching bastion host externalName from the overlay-bastions.yml that has the internal Ip which is in the range of the security list of the bastionjump instance.
For example: this is the related info for the region us-phoenix-1:
- region: us-phoenix-1

- private IP address of the bastionjump instance: 172.16.105.226

- bastion host externalName: vcn12-02.ob.us-phoenix-1.oci.oraclecloud.com with internalIP: 192.168.1.50

- CNAME: vcn16.ob.us-phoenix-1.oci.oraclecloud.com

so we fill in these info into the dlcdep_configs/dlcdep_phoenix_jumphosts file (assuming 'phoenix' is the new region name.)

# Jump Hosts 
> Host dlcdep-phoenix-prod-jump 
    HostName 172.16.105.226 
    ProxyJump vcn16.ob.us-phoenix-1.oci.oraclecloud.com

### Generate the Service Host List File
Make sure $HOME/.oci/config file is using the profile name "[dlcdep-boat]".

Make sure $HOME/.oci/config file has the region set to the new region full name, e.g., region=us-phoenix-1

Run the python script: generated_hosts.py and redirect the output to a new file:

> cd provisioning/ssh_config
> ./generate_hosts.py PROD <new region> > dlcdep_configs/dlcdep_<new region>_<env>_hosts
Replace <new region> with one of the simplified region names: 

ashburn, phoenix

### Include the Jump Host File and the Service Host List File
Update provisioning/ssh_config/dlcdep_configs/config file to include the new jump host file:
include dlcdep_configs/dlcdep_<new region>_jumphosts
Update provisioning/ssh_config/dlcdep_configs/dlcdep_<new region>_jumphosts, include the new service host list file:
Include dlcdep_configs/dlcdep_<new region>_<env>_hosts
Replace <new region> with one of the simplified region names: ashburn, phoenix
Access the Service Host to test


### Copy the new files to $HOME/.ssh/dlcdep_configs directory 
cp deployment-service-config/developer-configs/ssh/dlcdep_configs/* $HOME/.ssh/dlcdep_configs/
Make sure $HOME/.ssh/config file has the include lines like this:
Include ssh_configs/config
Include dlcdep_configs/config
Run the ssh command to connect to the service host in the new region. Note, the service host name is prefixed with the region. For example:
ssh dply-svc-ctrl-plne-api-beta-ad1.PHX
Note: you can find out the hostname aliases from the host list file: dlcdep_configs/dlcdep_<new region>_jumphosts

### A Note For Mac zsh Users:

The version of zsh that ships with current macOS is too old to support
tab-completing ssh config `Host` entries from files referenced via `Include`
directives. There is a workaround explained below, but it may not be worth doing
(see caveat below).

If you want to be able to tab complete the bastion hostnames when sshing, you'll
need to install a newer zsh via `brew install zsh` and update your user's login
shell to /usr/local/bin/zsh (right-click on your user in Users & Groups
preferences and choose Advanced Options to get to the screen where you set your
shell, then it will take effect next time you open a new terminal window).

**Caveat:** Unfortunately if you also have an Include directive for the SECEDGE SSH Config,
the tab completion gets really slow.
